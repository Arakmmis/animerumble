let socket = io();
Vue.use(VTooltip);
let app = new Vue({
  el: "#app",
  data: {
    message: "Hello Vuee.js!",
    source: {
      energy: {
        ally: {}
      }
    },
    packet: [],
    state: {
      skill: {
        offense: "",
        skill: null,
        target: "",
        aim: ""
      },
      timer: {
        turn: 100
      },
      onSkill: false,
      button: {},
      description: null,
      winner: {
        state: false,
        name: ""
      },
      energy: {
        modal: false,
        random: 0
      },
      exchange: {
        modal: false,
        used: false,
        energy: {},
        val: ""
      }
    },
    showModal: true
  },
  methods: {
    onExchange: function(e) {
      console.log(e);
      this.source.energy.ally = e.energy;
      this.state.exchange.energy = e.cost;
      this.state.exchange.modal = false;
      this.state.exchange.used = true;
      this.state.exchange.val = e.exchange;

      this.state.button.ally.forEach((x, xi) => {
        if (x.onSkill === false) {
          console.log(x.name);
          x.skill.forEach((s, si) => {
            let energy = energyManagement(
              { heroIndex: xi, skill: si },
              "check"
            );
            s.button = s.disabled || energy ? true : false;
            console.log(energy, s.disabled, s.button);
          });
        }
      });
    },
    onDone: function(e) {
      this.state.energy.modal = false;
      console.log(e.packet);
      let packet = e.packet;
      packet = packet.filter(
        x =>
          x.skill !== null &&
          x.offense !== "" &&
          x.target !== "" &&
          x.aim !== "" &&
          x.heroIndex !== null
      );
      packet.unshift(e.energy);
      if (this.state.exchange.used === true) {
        packet.unshift(
          { msg: "exchange", val: this.state.exchange.val },
          this.state.exchange.energy
        );
        this.state.exchange.used = false;
      }
      // this.packet = this.packet.filter(x => x.skill !== null && x.offense !== '' && x.target !== '' && x.aim !== '' && x.heroIndex !== null)
      // this.packet.unshift(e.energy)
      console.log(packet);
      socket.emit("sequence", {
        packet: packet,
        room: this.source.room
      });
      this.state.energy.random = 0;
      this.packet = [];
      console.log(e);
    },
    onSkill: function(payload) {
      //Define and Switch State
      let state = this.state;
      let marking = this.source.ally[payload.heroIndex].skill[
        payload.skillIndex
      ].marking;
      console.log(marking);
      let temporary = {
        offense: payload.name,
        skill: payload.skillIndex,
        skillId: payload.skillId,
        target: "",
        aim: payload.target,
        heroIndex: payload.heroIndex,
        marking: marking
      };
      console.log(state);
      console.log(payload);

      if (state.button.ally[temporary.heroIndex].onSkill === false) {
        //Buffer Skill
        state.skill = temporary;
        energyManagement(temporary, "substract");
        //Button Management
        buttonManagement(temporary, "onSkill");
      } else {
        energyManagement(temporary, "add");
        //Button Management
        if (
          state.button.ally[temporary.heroIndex].onSkill &&
          state.skill.heroIndex === null
        ) {
          buttonManagement(temporary, "onSelf");
        } else if (
          state.button.ally[temporary.heroIndex].onSkill &&
          state.skill.heroIndex !== null
        ) {
          buttonManagement(temporary, "onCancel");
        }
        // else {
        //     buttonManagement(temporary, 'onSkill')
        // }
        this.packet = this.packet.filter(x => x.offense !== temporary.offense);
        //Clean Skill Buffer
        state.skill = {
          offense: "",
          skill: null,
          skillId: null,
          target: "",
          aim: "",
          heroIndex: null
        };
      }

      //State Management
      state.button.ally[temporary.heroIndex].onSkill = !state.button.ally[
        temporary.heroIndex
      ].onSkill;
    },
    onTarget: function(payload) {
      //Define State
      let state = this.state;
      //Buffer Skill
      if (state.skill.aim === "allenemy" || state.skill.aim === "randomenemy") {
        state.skill.target = state.button.enemy
          .filter(x => x.disabled !== true && x.name !== payload.name)
          .map(x => x.name);
        state.skill.target.unshift(payload.name);
        console.log(state.skill.target);
      } else if (state.skill.aim === "allally") {
        state.skill.target = state.button.ally.map(x => x.name);
      } else if (state.skill.aim === "allenemyallally") {
        state.skill.target = state.button.enemy
          .filter(x => x.disabled !== true && x.name !== payload.name)
          .map(x => x.name);
        state.skill.target.unshift(payload.name);
        let ally = state.button.ally.map(x => x.name);
        state.skill.target = state.skill.target.concat(ally);
        console.log(state.skill.target);
      } else if (state.skill.aim === "otherally") {
        state.skill.target = state.button.ally
          .filter(x => x.name !== state.skill.offense)
          .map(x => x.name);
      } else {
        state.skill.target = [payload.name];
      }
      //Register Skill
      this.packet.push(this.state.skill);

      //Button Management
      buttonManagement(state.skill, "onTarget");

      //Clean Skill Buffer
      state.skill = {
        offense: "",
        skill: null,
        skillId: null,
        target: "",
        aim: "",
        heroIndex: null
      };
    },
    onAttack: function(payload) {
      this.state.energy.modal = true;
    },
    onDescription: function(payload) {
      let state = this.state;
      let temporary = {
        offense: payload.name,
        skill: payload.skillIndex,
        target: "",
        aim: payload.target,
        heroIndex: payload.heroIndex
      };

      //Buffer Skill
      state.description = {
        skill: temporary.skill,
        heroIndex: temporary.heroIndex
      };
    },
    onGetImage: function(payload, option) {
      if (option === "packet") {
        let index = this.source.ally.findIndex(x => x.name === payload.offense);
        let nameId = this.source.ally[index].nameId;

        return (
          "/assets/character/" +
          nameId +
          "/skill" +
          (payload.skill + 1) +
          "/avatar.jpg"
        );
      } else if (option === "char") {
        return "/assets/character/" + payload.nameId + "/avatar.jpg";
      } else if (option === "skill") {
        return (
          "/assets/character/" +
          payload.nameId +
          "/skill" +
          (payload.skill + 1) +
          "/avatar.jpg"
        );
      } else if (option === "status") {
        return (
          "/assets/character/" +
          payload.nameId +
          "/skill" +
          payload.skill +
          "/avatar.jpg"
        );
      }
    }
  }
});

function energyManagement(temporary, option) {
  let energy = temporary.energy ? temporary.energy : app.source.energy.ally;
  let skill = temporary.skillBind
    ? temporary.skillBind
    : app.source.ally[temporary.heroIndex].skill[temporary.skill].energy;
  let total = {
    energy: energy.a + energy.i + energy.s + energy.w,
    skill: skill.a + skill.i + skill.s + skill.w
  };

  if (option === "substract") {
    console.log("test");
    if (skill.a > 0) {
      energy.a -= skill.a;
      energy.r -= skill.a;
    }
    if (skill.i > 0) {
      energy.i -= skill.i;
      energy.r -= skill.i;
    }
    if (skill.s > 0) {
      energy.s -= skill.s;
      energy.r -= skill.s;
    }
    if (skill.w > 0) {
      energy.w -= skill.w;
      energy.r -= skill.w;
    }
    if (skill.r > 0) {
      energy.r -= skill.r;
      app.state.energy.random += skill.r;
    }
  } else if (option === "add") {
    if (skill.a > 0) {
      energy.a += skill.a;
      energy.r += skill.a;
    }
    if (skill.i > 0) {
      energy.i += skill.i;
      energy.r += skill.i;
    }
    if (skill.s > 0) {
      energy.s += skill.s;
      energy.r += skill.s;
    }
    if (skill.w > 0) {
      energy.w += skill.w;
      energy.r += skill.w;
    }
    if (skill.r > 0) {
      energy.r += skill.r;
      app.state.energy.random -= skill.r;
    }
  } else if (option === "check") {
    let active = true;
    if (total.energy >= total.skill) {
      let count = [true, true, true, true, true];
      if (skill.a >= 0) {
        count[0] = energy.a >= skill.a ? false : true;
      }
      if (skill.i >= 0) {
        count[1] = energy.i >= skill.i ? false : true;
      }
      if (skill.s >= 0) {
        count[2] = energy.s >= skill.s ? false : true;
      }
      if (skill.w >= 0) {
        count[3] = energy.w >= skill.w ? false : true;
      }
      if (skill.r >= 0) {
        count[4] = energy.r >= total.skill + skill.r ? false : true;
      }

      if (count.filter(x => x === false).length === 5) {
        active = false;
      } else {
        active = true;
      }
    }
    return active;
  }
}

function buttonManagement(payload, option) {
  //Target Button
  if (option !== "onSelf") {
    if (payload.aim === "enemy") {
      app.state.button.enemy.forEach(x => {
        x.button = x.disabled ? true : !x.button;
        if (payload.marking === true) {
          let skillName =
            app.source.ally[payload.heroIndex].skill[payload.skill].name;
          let marking =
            app.source.enemy[x.index].status.onReceive.some(
              x => x.name === skillName
            ) ||
            app.source.enemy[x.index].status.onState.some(
              x => x.name === skillName
            );
          if (marking === true) {
            x.button = true;
          }
        }
      });
    } else if (payload.aim === "allenemy" || payload.aim === "randomenemy") {
      app.state.button.enemy.forEach(
        x => (x.button = x.disabled ? true : !x.button)
      );
    } else if (payload.aim === "allenemyallally") {
      app.state.button.enemy.forEach(
        x => (x.button = x.disabled ? true : !x.button)
      );
    } else if (payload.aim === "ally") {
      app.state.button.ally.forEach(
        x => (x.button = x.disabled ? true : !x.button)
      );
    } else if (payload.aim === "allally") {
      app.state.button.ally.forEach(
        x => (x.button = x.disabled ? true : !x.button)
      );
    } else if (payload.aim === "otherally") {
      app.state.button.ally.forEach(x => {
        let name = app.state.button.ally[payload.heroIndex].name;
        if (x.name !== name) {
          x.button = x.disabled ? true : !x.button;
        }
      });
    } else if (payload.aim === "self") {
      app.state.button.ally[payload.heroIndex].button = app.state.button.ally[
        payload.heroIndex
      ].disabled
        ? true
        : !app.state.button.ally[payload.heroIndex].button;
    }
  }

  //Skill Button
  if (option === "onSkill") {
    console.log("onSkill");
    app.state.button.ally.forEach(x => {
      if (x.onSkill === false) {
        x.skill.forEach(s => {
          s.button = true;
          if (
            x.name === payload.offense &&
            s.name ===
              app.source.ally[payload.heroIndex].skill[payload.skill].name
          ) {
            s.button = false;
          }
        });
      }
    });
  }
  if (option === "onCancel") {
    console.log("onCancel");
    app.state.button.ally.forEach(x => {
      if (x.onSkill === false || x.name === payload.offense) {
        x.skill.forEach(s => {
          s.button = s.disabled ? true : false;
          if (
            x.name === payload.offense &&
            s.name ===
              app.source.ally[payload.heroIndex].skill[payload.skill].name
          ) {
            s.button = false;
          }
        });
      }
    });
  } else if (option === "onTarget") {
    console.log("onTarget");
    app.state.button.ally.forEach(x => {
      let index = app.packet.findIndex(s => s.offense === x.name);
      if (index < 0) {
        x.skill.forEach(s => {
          s.button = s.disabled ? true : false;
        });
      }
    });
  } else if (option === "onSelf") {
    console.log("onSelf");
    app.state.button.ally[payload.heroIndex].skill.forEach(s => {
      s.button = s.disabled ? true : false;
    });
  }

  //Energy Management
  if (option !== "onSkill") {
    app.state.button.ally.forEach((x, xi) => {
      if (x.onSkill === false && x.name !== payload.offense) {
        console.log(x.name);
        console.log(option);
        x.skill.forEach((s, si) => {
          let energy = energyManagement({ heroIndex: xi, skill: si }, "check");
          s.button = s.disabled || energy ? true : false;
          if (
            x.name === payload.offense &&
            s.name ===
              app.source.ally[payload.heroIndex].skill[payload.skill].name
          ) {
            s.button = false;
          }
        });
      }

      if (
        (option === "onSelf" || option === "onCancel") &&
        x.name === payload.offense
      ) {
        x.skill.forEach((s, si) => {
          let energy = energyManagement({ heroIndex: xi, skill: si }, "check");
          s.button = s.disabled || energy ? true : false;
        });
      }
    });
  }
}

function vueBind(payload) {
  let username = getCookie("username");
  if (payload.team.teamEven !== username && payload.team.teamOdd !== username) {
    return;
  }
  console.log(payload);
  let ally = payload.team.teamEven === username ? "teamEven" : "teamOdd";
  let enemy = payload.team.teamEven === username ? "teamOdd" : "teamEven";
  let turn = ally === "teamEven" ? 1 : 0;
  let myTurn = payload.turn % 2 === turn ? true : false;
  let store = {
    energy: {
      ally: payload.energy[ally],
      enemy: payload.energy[enemy]
    },
    ally: payload[ally],
    enemy: payload[enemy],
    turn: payload.turn,
    myTurn: myTurn,
    room: payload.room
  };
  store.energy.ally.r =
    store.energy.ally.a +
    store.energy.ally.i +
    store.energy.ally.s +
    store.energy.ally.w;
  console.log(store);
  let button = {
    ally: store.ally.map(x => {
      // let disabled = x.status.onState.findIndex(x => x.type === 'stun') > -1 || x.hp <= 0 ? true : false
      let disabled = x.hp <= 0 ? true : false;
      let stun =
        x.status.onState.findIndex(x => x.type === "stun") > -1 ? true : false;
      return {
        name: x.name,
        button: true,
        onSkill: false,
        disabled: disabled,
        skill: x.skill.map(s => {
          let energy = energyManagement(
            { energy: store.energy.ally, skillBind: s.energy },
            "check"
          );
          console.log(energy);
          let disabled =
            stun ||
            s.required ||
            s.state === "cooldown" ||
            !myTurn === false ||
            x.hp <= 0
              ? true
              : false;
          return {
            name: s.name,
            disabled: disabled,
            button: disabled || energy ? true : false
          };
        })
      };
    }),
    enemy: store.enemy.map((x, i) => {
      let disabled =
        x.status.onState.findIndex(x => x.type === "invincible") > -1 ||
        x.hp <= 0
          ? true
          : false;
      return {
        name: x.name,
        index: i,
        disabled: disabled,
        button: true
      };
    })
  };
  app.source = store;
  app.state.button = button;
  app.state.timer.turn = 100;
  app.state.winner = payload.winner;
}

function initiate() {
  let url = window.location.href.split("/");
  let room = url[url.length - 1];
  if (room !== "") {
    socket.emit("initiate", {
      room: room
    });
  } else {
    // window.location.replace('/');
  }
}

initiate();

setInterval(() => {
  if (app.source.turn == undefined || app.state.winner.state !== false) {
    return;
  }
  if (app.state.timer.turn > 0) {
    app.state.timer.turn -= 3.3;
  } else if (app.state.timer.turn <= 0 && app.source.myTurn === true) {
    // app.packet = app.packet.filter(x => x.skill !== null && x.offense !== '' && x.target !== '' && x.aim !== '' && x.heroIndex !== null)
    // socket.emit('sequence', {
    //     packet: app.packet,
    //     room: app.source.room
    // })
    // app.packet = []
  }
}, 1000);

window.onfocus = function() {
  document.title = "Anime Rumble";
};

socket.on("apply", payload => {
  document.title = "(!) Anime Rumble";
  vueBind(payload);
});

socket.on("noMatch", payload => {
  console.log("none");
  window.location.replace("/");
});

function getParameterName(name, url) {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
    results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return "";
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

const setCookie = (name, value, days = 7, path = "/") => {
  const expires = new Date(Date.now() + days * 864e5).toGMTString();
  document.cookie =
    name +
    "=" +
    encodeURIComponent(value) +
    "; expires=" +
    expires +
    "; path=" +
    path;
};

const getCookie = name => {
  return document.cookie.split("; ").reduce((r, v) => {
    const parts = v.split("=");
    return parts[0] === name ? decodeURIComponent(parts[1]) : r;
  }, "");
};

const deleteCookie = (name, path) => {
  setCookie(name, "", -1, path);
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNldHVwLmpzIiwidnVlLmpzIiwibWFuYWdlbWVudC5qcyIsInJlbmRlcmVyLmpzIiwiZ2VuZXJhbC5qcyIsInNvY2tldC5qcyIsImhlbHBlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMU5BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2FtZS5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJsZXQgc29ja2V0ID0gaW8oKTsiLCJWdWUudXNlKFZUb29sdGlwKTtcbmxldCBhcHAgPSBuZXcgVnVlKHtcbiAgZWw6IFwiI2FwcFwiLFxuICBkYXRhOiB7XG4gICAgbWVzc2FnZTogXCJIZWxsbyBWdWVlLmpzIVwiLFxuICAgIHNvdXJjZToge1xuICAgICAgZW5lcmd5OiB7XG4gICAgICAgIGFsbHk6IHt9XG4gICAgICB9XG4gICAgfSxcbiAgICBwYWNrZXQ6IFtdLFxuICAgIHN0YXRlOiB7XG4gICAgICBza2lsbDoge1xuICAgICAgICBvZmZlbnNlOiBcIlwiLFxuICAgICAgICBza2lsbDogbnVsbCxcbiAgICAgICAgdGFyZ2V0OiBcIlwiLFxuICAgICAgICBhaW06IFwiXCJcbiAgICAgIH0sXG4gICAgICB0aW1lcjoge1xuICAgICAgICB0dXJuOiAxMDBcbiAgICAgIH0sXG4gICAgICBvblNraWxsOiBmYWxzZSxcbiAgICAgIGJ1dHRvbjoge30sXG4gICAgICBkZXNjcmlwdGlvbjogbnVsbCxcbiAgICAgIHdpbm5lcjoge1xuICAgICAgICBzdGF0ZTogZmFsc2UsXG4gICAgICAgIG5hbWU6IFwiXCJcbiAgICAgIH0sXG4gICAgICBlbmVyZ3k6IHtcbiAgICAgICAgbW9kYWw6IGZhbHNlLFxuICAgICAgICByYW5kb206IDBcbiAgICAgIH0sXG4gICAgICBleGNoYW5nZToge1xuICAgICAgICBtb2RhbDogZmFsc2UsXG4gICAgICAgIHVzZWQ6IGZhbHNlLFxuICAgICAgICBlbmVyZ3k6IHt9LFxuICAgICAgICB2YWw6IFwiXCJcbiAgICAgIH1cbiAgICB9LFxuICAgIHNob3dNb2RhbDogdHJ1ZVxuICB9LFxuICBtZXRob2RzOiB7XG4gICAgb25FeGNoYW5nZTogZnVuY3Rpb24oZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLnNvdXJjZS5lbmVyZ3kuYWxseSA9IGUuZW5lcmd5O1xuICAgICAgdGhpcy5zdGF0ZS5leGNoYW5nZS5lbmVyZ3kgPSBlLmNvc3Q7XG4gICAgICB0aGlzLnN0YXRlLmV4Y2hhbmdlLm1vZGFsID0gZmFsc2U7XG4gICAgICB0aGlzLnN0YXRlLmV4Y2hhbmdlLnVzZWQgPSB0cnVlO1xuICAgICAgdGhpcy5zdGF0ZS5leGNoYW5nZS52YWwgPSBlLmV4Y2hhbmdlO1xuXG4gICAgICB0aGlzLnN0YXRlLmJ1dHRvbi5hbGx5LmZvckVhY2goKHgsIHhpKSA9PiB7XG4gICAgICAgIGlmICh4Lm9uU2tpbGwgPT09IGZhbHNlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coeC5uYW1lKTtcbiAgICAgICAgICB4LnNraWxsLmZvckVhY2goKHMsIHNpKSA9PiB7XG4gICAgICAgICAgICBsZXQgZW5lcmd5ID0gZW5lcmd5TWFuYWdlbWVudChcbiAgICAgICAgICAgICAgeyBoZXJvSW5kZXg6IHhpLCBza2lsbDogc2kgfSxcbiAgICAgICAgICAgICAgXCJjaGVja1wiXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcy5idXR0b24gPSBzLmRpc2FibGVkIHx8IGVuZXJneSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVuZXJneSwgcy5kaXNhYmxlZCwgcy5idXR0b24pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9LFxuICAgIG9uRG9uZTogZnVuY3Rpb24oZSkge1xuICAgICAgdGhpcy5zdGF0ZS5lbmVyZ3kubW9kYWwgPSBmYWxzZTtcbiAgICAgIGNvbnNvbGUubG9nKGUucGFja2V0KTtcbiAgICAgIGxldCBwYWNrZXQgPSBlLnBhY2tldDtcbiAgICAgIHBhY2tldCA9IHBhY2tldC5maWx0ZXIoXG4gICAgICAgIHggPT5cbiAgICAgICAgICB4LnNraWxsICE9PSBudWxsICYmXG4gICAgICAgICAgeC5vZmZlbnNlICE9PSBcIlwiICYmXG4gICAgICAgICAgeC50YXJnZXQgIT09IFwiXCIgJiZcbiAgICAgICAgICB4LmFpbSAhPT0gXCJcIiAmJlxuICAgICAgICAgIHguaGVyb0luZGV4ICE9PSBudWxsXG4gICAgICApO1xuICAgICAgcGFja2V0LnVuc2hpZnQoZS5lbmVyZ3kpO1xuICAgICAgaWYgKHRoaXMuc3RhdGUuZXhjaGFuZ2UudXNlZCA9PT0gdHJ1ZSkge1xuICAgICAgICBwYWNrZXQudW5zaGlmdChcbiAgICAgICAgICB7IG1zZzogXCJleGNoYW5nZVwiLCB2YWw6IHRoaXMuc3RhdGUuZXhjaGFuZ2UudmFsIH0sXG4gICAgICAgICAgdGhpcy5zdGF0ZS5leGNoYW5nZS5lbmVyZ3lcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5leGNoYW5nZS51c2VkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICAvLyB0aGlzLnBhY2tldCA9IHRoaXMucGFja2V0LmZpbHRlcih4ID0+IHguc2tpbGwgIT09IG51bGwgJiYgeC5vZmZlbnNlICE9PSAnJyAmJiB4LnRhcmdldCAhPT0gJycgJiYgeC5haW0gIT09ICcnICYmIHguaGVyb0luZGV4ICE9PSBudWxsKVxuICAgICAgLy8gdGhpcy5wYWNrZXQudW5zaGlmdChlLmVuZXJneSlcbiAgICAgIGNvbnNvbGUubG9nKHBhY2tldCk7XG4gICAgICBzb2NrZXQuZW1pdChcInNlcXVlbmNlXCIsIHtcbiAgICAgICAgcGFja2V0OiBwYWNrZXQsXG4gICAgICAgIHJvb206IHRoaXMuc291cmNlLnJvb21cbiAgICAgIH0pO1xuICAgICAgdGhpcy5zdGF0ZS5lbmVyZ3kucmFuZG9tID0gMDtcbiAgICAgIHRoaXMucGFja2V0ID0gW107XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9LFxuICAgIG9uU2tpbGw6IGZ1bmN0aW9uKHBheWxvYWQpIHtcbiAgICAgIC8vRGVmaW5lIGFuZCBTd2l0Y2ggU3RhdGVcbiAgICAgIGxldCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgICBsZXQgbWFya2luZyA9IHRoaXMuc291cmNlLmFsbHlbcGF5bG9hZC5oZXJvSW5kZXhdLnNraWxsW1xuICAgICAgICBwYXlsb2FkLnNraWxsSW5kZXhcbiAgICAgIF0ubWFya2luZztcbiAgICAgIGNvbnNvbGUubG9nKG1hcmtpbmcpO1xuICAgICAgbGV0IHRlbXBvcmFyeSA9IHtcbiAgICAgICAgb2ZmZW5zZTogcGF5bG9hZC5uYW1lLFxuICAgICAgICBza2lsbDogcGF5bG9hZC5za2lsbEluZGV4LFxuICAgICAgICBza2lsbElkOiBwYXlsb2FkLnNraWxsSWQsXG4gICAgICAgIHRhcmdldDogXCJcIixcbiAgICAgICAgYWltOiBwYXlsb2FkLnRhcmdldCxcbiAgICAgICAgaGVyb0luZGV4OiBwYXlsb2FkLmhlcm9JbmRleCxcbiAgICAgICAgbWFya2luZzogbWFya2luZ1xuICAgICAgfTtcbiAgICAgIGNvbnNvbGUubG9nKHN0YXRlKTtcbiAgICAgIGNvbnNvbGUubG9nKHBheWxvYWQpO1xuXG4gICAgICBpZiAoc3RhdGUuYnV0dG9uLmFsbHlbdGVtcG9yYXJ5Lmhlcm9JbmRleF0ub25Ta2lsbCA9PT0gZmFsc2UpIHtcbiAgICAgICAgLy9CdWZmZXIgU2tpbGxcbiAgICAgICAgc3RhdGUuc2tpbGwgPSB0ZW1wb3Jhcnk7XG4gICAgICAgIGVuZXJneU1hbmFnZW1lbnQodGVtcG9yYXJ5LCBcInN1YnN0cmFjdFwiKTtcbiAgICAgICAgLy9CdXR0b24gTWFuYWdlbWVudFxuICAgICAgICBidXR0b25NYW5hZ2VtZW50KHRlbXBvcmFyeSwgXCJvblNraWxsXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZW5lcmd5TWFuYWdlbWVudCh0ZW1wb3JhcnksIFwiYWRkXCIpO1xuICAgICAgICAvL0J1dHRvbiBNYW5hZ2VtZW50XG4gICAgICAgIGlmIChcbiAgICAgICAgICBzdGF0ZS5idXR0b24uYWxseVt0ZW1wb3JhcnkuaGVyb0luZGV4XS5vblNraWxsICYmXG4gICAgICAgICAgc3RhdGUuc2tpbGwuaGVyb0luZGV4ID09PSBudWxsXG4gICAgICAgICkge1xuICAgICAgICAgIGJ1dHRvbk1hbmFnZW1lbnQodGVtcG9yYXJ5LCBcIm9uU2VsZlwiKTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICBzdGF0ZS5idXR0b24uYWxseVt0ZW1wb3JhcnkuaGVyb0luZGV4XS5vblNraWxsICYmXG4gICAgICAgICAgc3RhdGUuc2tpbGwuaGVyb0luZGV4ICE9PSBudWxsXG4gICAgICAgICkge1xuICAgICAgICAgIGJ1dHRvbk1hbmFnZW1lbnQodGVtcG9yYXJ5LCBcIm9uQ2FuY2VsXCIpO1xuICAgICAgICB9XG4gICAgICAgIC8vIGVsc2Uge1xuICAgICAgICAvLyAgICAgYnV0dG9uTWFuYWdlbWVudCh0ZW1wb3JhcnksICdvblNraWxsJylcbiAgICAgICAgLy8gfVxuICAgICAgICB0aGlzLnBhY2tldCA9IHRoaXMucGFja2V0LmZpbHRlcih4ID0+IHgub2ZmZW5zZSAhPT0gdGVtcG9yYXJ5Lm9mZmVuc2UpO1xuICAgICAgICAvL0NsZWFuIFNraWxsIEJ1ZmZlclxuICAgICAgICBzdGF0ZS5za2lsbCA9IHtcbiAgICAgICAgICBvZmZlbnNlOiBcIlwiLFxuICAgICAgICAgIHNraWxsOiBudWxsLFxuICAgICAgICAgIHNraWxsSWQ6IG51bGwsXG4gICAgICAgICAgdGFyZ2V0OiBcIlwiLFxuICAgICAgICAgIGFpbTogXCJcIixcbiAgICAgICAgICBoZXJvSW5kZXg6IG51bGxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy9TdGF0ZSBNYW5hZ2VtZW50XG4gICAgICBzdGF0ZS5idXR0b24uYWxseVt0ZW1wb3JhcnkuaGVyb0luZGV4XS5vblNraWxsID0gIXN0YXRlLmJ1dHRvbi5hbGx5W1xuICAgICAgICB0ZW1wb3JhcnkuaGVyb0luZGV4XG4gICAgICBdLm9uU2tpbGw7XG4gICAgfSxcbiAgICBvblRhcmdldDogZnVuY3Rpb24ocGF5bG9hZCkge1xuICAgICAgLy9EZWZpbmUgU3RhdGVcbiAgICAgIGxldCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgICAvL0J1ZmZlciBTa2lsbFxuICAgICAgaWYgKHN0YXRlLnNraWxsLmFpbSA9PT0gXCJhbGxlbmVteVwiIHx8IHN0YXRlLnNraWxsLmFpbSA9PT0gXCJyYW5kb21lbmVteVwiKSB7XG4gICAgICAgIHN0YXRlLnNraWxsLnRhcmdldCA9IHN0YXRlLmJ1dHRvbi5lbmVteVxuICAgICAgICAgIC5maWx0ZXIoeCA9PiB4LmRpc2FibGVkICE9PSB0cnVlICYmIHgubmFtZSAhPT0gcGF5bG9hZC5uYW1lKVxuICAgICAgICAgIC5tYXAoeCA9PiB4Lm5hbWUpO1xuICAgICAgICBzdGF0ZS5za2lsbC50YXJnZXQudW5zaGlmdChwYXlsb2FkLm5hbWUpO1xuICAgICAgICBjb25zb2xlLmxvZyhzdGF0ZS5za2lsbC50YXJnZXQpO1xuICAgICAgfSBlbHNlIGlmIChzdGF0ZS5za2lsbC5haW0gPT09IFwiYWxsYWxseVwiKSB7XG4gICAgICAgIHN0YXRlLnNraWxsLnRhcmdldCA9IHN0YXRlLmJ1dHRvbi5hbGx5Lm1hcCh4ID0+IHgubmFtZSk7XG4gICAgICB9IGVsc2UgaWYgKHN0YXRlLnNraWxsLmFpbSA9PT0gXCJhbGxlbmVteWFsbGFsbHlcIikge1xuICAgICAgICBzdGF0ZS5za2lsbC50YXJnZXQgPSBzdGF0ZS5idXR0b24uZW5lbXlcbiAgICAgICAgICAuZmlsdGVyKHggPT4geC5kaXNhYmxlZCAhPT0gdHJ1ZSAmJiB4Lm5hbWUgIT09IHBheWxvYWQubmFtZSlcbiAgICAgICAgICAubWFwKHggPT4geC5uYW1lKTtcbiAgICAgICAgc3RhdGUuc2tpbGwudGFyZ2V0LnVuc2hpZnQocGF5bG9hZC5uYW1lKTtcbiAgICAgICAgbGV0IGFsbHkgPSBzdGF0ZS5idXR0b24uYWxseS5tYXAoeCA9PiB4Lm5hbWUpO1xuICAgICAgICBzdGF0ZS5za2lsbC50YXJnZXQgPSBzdGF0ZS5za2lsbC50YXJnZXQuY29uY2F0KGFsbHkpO1xuICAgICAgICBjb25zb2xlLmxvZyhzdGF0ZS5za2lsbC50YXJnZXQpO1xuICAgICAgfSBlbHNlIGlmIChzdGF0ZS5za2lsbC5haW0gPT09IFwib3RoZXJhbGx5XCIpIHtcbiAgICAgICAgc3RhdGUuc2tpbGwudGFyZ2V0ID0gc3RhdGUuYnV0dG9uLmFsbHlcbiAgICAgICAgICAuZmlsdGVyKHggPT4geC5uYW1lICE9PSBzdGF0ZS5za2lsbC5vZmZlbnNlKVxuICAgICAgICAgIC5tYXAoeCA9PiB4Lm5hbWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUuc2tpbGwudGFyZ2V0ID0gW3BheWxvYWQubmFtZV07XG4gICAgICB9XG4gICAgICAvL1JlZ2lzdGVyIFNraWxsXG4gICAgICB0aGlzLnBhY2tldC5wdXNoKHRoaXMuc3RhdGUuc2tpbGwpO1xuXG4gICAgICAvL0J1dHRvbiBNYW5hZ2VtZW50XG4gICAgICBidXR0b25NYW5hZ2VtZW50KHN0YXRlLnNraWxsLCBcIm9uVGFyZ2V0XCIpO1xuXG4gICAgICAvL0NsZWFuIFNraWxsIEJ1ZmZlclxuICAgICAgc3RhdGUuc2tpbGwgPSB7XG4gICAgICAgIG9mZmVuc2U6IFwiXCIsXG4gICAgICAgIHNraWxsOiBudWxsLFxuICAgICAgICBza2lsbElkOiBudWxsLFxuICAgICAgICB0YXJnZXQ6IFwiXCIsXG4gICAgICAgIGFpbTogXCJcIixcbiAgICAgICAgaGVyb0luZGV4OiBudWxsXG4gICAgICB9O1xuICAgIH0sXG4gICAgb25BdHRhY2s6IGZ1bmN0aW9uKHBheWxvYWQpIHtcbiAgICAgIHRoaXMuc3RhdGUuZW5lcmd5Lm1vZGFsID0gdHJ1ZTtcbiAgICB9LFxuICAgIG9uRGVzY3JpcHRpb246IGZ1bmN0aW9uKHBheWxvYWQpIHtcbiAgICAgIGxldCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgICBsZXQgdGVtcG9yYXJ5ID0ge1xuICAgICAgICBvZmZlbnNlOiBwYXlsb2FkLm5hbWUsXG4gICAgICAgIHNraWxsOiBwYXlsb2FkLnNraWxsSW5kZXgsXG4gICAgICAgIHRhcmdldDogXCJcIixcbiAgICAgICAgYWltOiBwYXlsb2FkLnRhcmdldCxcbiAgICAgICAgaGVyb0luZGV4OiBwYXlsb2FkLmhlcm9JbmRleFxuICAgICAgfTtcblxuICAgICAgLy9CdWZmZXIgU2tpbGxcbiAgICAgIHN0YXRlLmRlc2NyaXB0aW9uID0ge1xuICAgICAgICBza2lsbDogdGVtcG9yYXJ5LnNraWxsLFxuICAgICAgICBoZXJvSW5kZXg6IHRlbXBvcmFyeS5oZXJvSW5kZXhcbiAgICAgIH07XG4gICAgfSxcbiAgICBvbkdldEltYWdlOiBmdW5jdGlvbihwYXlsb2FkLCBvcHRpb24pIHtcbiAgICAgIGlmIChvcHRpb24gPT09IFwicGFja2V0XCIpIHtcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5zb3VyY2UuYWxseS5maW5kSW5kZXgoeCA9PiB4Lm5hbWUgPT09IHBheWxvYWQub2ZmZW5zZSk7XG4gICAgICAgIGxldCBuYW1lSWQgPSB0aGlzLnNvdXJjZS5hbGx5W2luZGV4XS5uYW1lSWQ7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBcIi9hc3NldHMvY2hhcmFjdGVyL1wiICtcbiAgICAgICAgICBuYW1lSWQgK1xuICAgICAgICAgIFwiL3NraWxsXCIgK1xuICAgICAgICAgIChwYXlsb2FkLnNraWxsICsgMSkgK1xuICAgICAgICAgIFwiL2F2YXRhci5qcGdcIlxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChvcHRpb24gPT09IFwiY2hhclwiKSB7XG4gICAgICAgIHJldHVybiBcIi9hc3NldHMvY2hhcmFjdGVyL1wiICsgcGF5bG9hZC5uYW1lSWQgKyBcIi9hdmF0YXIuanBnXCI7XG4gICAgICB9IGVsc2UgaWYgKG9wdGlvbiA9PT0gXCJza2lsbFwiKSB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgXCIvYXNzZXRzL2NoYXJhY3Rlci9cIiArXG4gICAgICAgICAgcGF5bG9hZC5uYW1lSWQgK1xuICAgICAgICAgIFwiL3NraWxsXCIgK1xuICAgICAgICAgIChwYXlsb2FkLnNraWxsICsgMSkgK1xuICAgICAgICAgIFwiL2F2YXRhci5qcGdcIlxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChvcHRpb24gPT09IFwic3RhdHVzXCIpIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBcIi9hc3NldHMvY2hhcmFjdGVyL1wiICtcbiAgICAgICAgICBwYXlsb2FkLm5hbWVJZCArXG4gICAgICAgICAgXCIvc2tpbGxcIiArXG4gICAgICAgICAgcGF5bG9hZC5za2lsbCArXG4gICAgICAgICAgXCIvYXZhdGFyLmpwZ1wiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG59KTtcbiIsImZ1bmN0aW9uIGVuZXJneU1hbmFnZW1lbnQodGVtcG9yYXJ5LCBvcHRpb24pIHtcbiAgbGV0IGVuZXJneSA9IHRlbXBvcmFyeS5lbmVyZ3kgPyB0ZW1wb3JhcnkuZW5lcmd5IDogYXBwLnNvdXJjZS5lbmVyZ3kuYWxseTtcbiAgbGV0IHNraWxsID0gdGVtcG9yYXJ5LnNraWxsQmluZFxuICAgID8gdGVtcG9yYXJ5LnNraWxsQmluZFxuICAgIDogYXBwLnNvdXJjZS5hbGx5W3RlbXBvcmFyeS5oZXJvSW5kZXhdLnNraWxsW3RlbXBvcmFyeS5za2lsbF0uZW5lcmd5O1xuICBsZXQgdG90YWwgPSB7XG4gICAgZW5lcmd5OiBlbmVyZ3kuYSArIGVuZXJneS5pICsgZW5lcmd5LnMgKyBlbmVyZ3kudyxcbiAgICBza2lsbDogc2tpbGwuYSArIHNraWxsLmkgKyBza2lsbC5zICsgc2tpbGwud1xuICB9O1xuXG4gIGlmIChvcHRpb24gPT09IFwic3Vic3RyYWN0XCIpIHtcbiAgICBjb25zb2xlLmxvZyhcInRlc3RcIik7XG4gICAgaWYgKHNraWxsLmEgPiAwKSB7XG4gICAgICBlbmVyZ3kuYSAtPSBza2lsbC5hO1xuICAgICAgZW5lcmd5LnIgLT0gc2tpbGwuYTtcbiAgICB9XG4gICAgaWYgKHNraWxsLmkgPiAwKSB7XG4gICAgICBlbmVyZ3kuaSAtPSBza2lsbC5pO1xuICAgICAgZW5lcmd5LnIgLT0gc2tpbGwuaTtcbiAgICB9XG4gICAgaWYgKHNraWxsLnMgPiAwKSB7XG4gICAgICBlbmVyZ3kucyAtPSBza2lsbC5zO1xuICAgICAgZW5lcmd5LnIgLT0gc2tpbGwucztcbiAgICB9XG4gICAgaWYgKHNraWxsLncgPiAwKSB7XG4gICAgICBlbmVyZ3kudyAtPSBza2lsbC53O1xuICAgICAgZW5lcmd5LnIgLT0gc2tpbGwudztcbiAgICB9XG4gICAgaWYgKHNraWxsLnIgPiAwKSB7XG4gICAgICBlbmVyZ3kuciAtPSBza2lsbC5yO1xuICAgICAgYXBwLnN0YXRlLmVuZXJneS5yYW5kb20gKz0gc2tpbGwucjtcbiAgICB9XG4gIH0gZWxzZSBpZiAob3B0aW9uID09PSBcImFkZFwiKSB7XG4gICAgaWYgKHNraWxsLmEgPiAwKSB7XG4gICAgICBlbmVyZ3kuYSArPSBza2lsbC5hO1xuICAgICAgZW5lcmd5LnIgKz0gc2tpbGwuYTtcbiAgICB9XG4gICAgaWYgKHNraWxsLmkgPiAwKSB7XG4gICAgICBlbmVyZ3kuaSArPSBza2lsbC5pO1xuICAgICAgZW5lcmd5LnIgKz0gc2tpbGwuaTtcbiAgICB9XG4gICAgaWYgKHNraWxsLnMgPiAwKSB7XG4gICAgICBlbmVyZ3kucyArPSBza2lsbC5zO1xuICAgICAgZW5lcmd5LnIgKz0gc2tpbGwucztcbiAgICB9XG4gICAgaWYgKHNraWxsLncgPiAwKSB7XG4gICAgICBlbmVyZ3kudyArPSBza2lsbC53O1xuICAgICAgZW5lcmd5LnIgKz0gc2tpbGwudztcbiAgICB9XG4gICAgaWYgKHNraWxsLnIgPiAwKSB7XG4gICAgICBlbmVyZ3kuciArPSBza2lsbC5yO1xuICAgICAgYXBwLnN0YXRlLmVuZXJneS5yYW5kb20gLT0gc2tpbGwucjtcbiAgICB9XG4gIH0gZWxzZSBpZiAob3B0aW9uID09PSBcImNoZWNrXCIpIHtcbiAgICBsZXQgYWN0aXZlID0gdHJ1ZTtcbiAgICBpZiAodG90YWwuZW5lcmd5ID49IHRvdGFsLnNraWxsKSB7XG4gICAgICBsZXQgY291bnQgPSBbdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZV07XG4gICAgICBpZiAoc2tpbGwuYSA+PSAwKSB7XG4gICAgICAgIGNvdW50WzBdID0gZW5lcmd5LmEgPj0gc2tpbGwuYSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChza2lsbC5pID49IDApIHtcbiAgICAgICAgY291bnRbMV0gPSBlbmVyZ3kuaSA+PSBza2lsbC5pID8gZmFsc2UgOiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKHNraWxsLnMgPj0gMCkge1xuICAgICAgICBjb3VudFsyXSA9IGVuZXJneS5zID49IHNraWxsLnMgPyBmYWxzZSA6IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAoc2tpbGwudyA+PSAwKSB7XG4gICAgICAgIGNvdW50WzNdID0gZW5lcmd5LncgPj0gc2tpbGwudyA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChza2lsbC5yID49IDApIHtcbiAgICAgICAgY291bnRbNF0gPSBlbmVyZ3kuciA+PSB0b3RhbC5za2lsbCArIHNraWxsLnIgPyBmYWxzZSA6IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb3VudC5maWx0ZXIoeCA9PiB4ID09PSBmYWxzZSkubGVuZ3RoID09PSA1KSB7XG4gICAgICAgIGFjdGl2ZSA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWN0aXZlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFjdGl2ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBidXR0b25NYW5hZ2VtZW50KHBheWxvYWQsIG9wdGlvbikge1xuICAvL1RhcmdldCBCdXR0b25cbiAgaWYgKG9wdGlvbiAhPT0gXCJvblNlbGZcIikge1xuICAgIGlmIChwYXlsb2FkLmFpbSA9PT0gXCJlbmVteVwiKSB7XG4gICAgICBhcHAuc3RhdGUuYnV0dG9uLmVuZW15LmZvckVhY2goeCA9PiB7XG4gICAgICAgIHguYnV0dG9uID0geC5kaXNhYmxlZCA/IHRydWUgOiAheC5idXR0b247XG4gICAgICAgIGlmIChwYXlsb2FkLm1hcmtpbmcgPT09IHRydWUpIHtcbiAgICAgICAgICBsZXQgc2tpbGxOYW1lID1cbiAgICAgICAgICAgIGFwcC5zb3VyY2UuYWxseVtwYXlsb2FkLmhlcm9JbmRleF0uc2tpbGxbcGF5bG9hZC5za2lsbF0ubmFtZTtcbiAgICAgICAgICBsZXQgbWFya2luZyA9XG4gICAgICAgICAgICBhcHAuc291cmNlLmVuZW15W3guaW5kZXhdLnN0YXR1cy5vblJlY2VpdmUuc29tZShcbiAgICAgICAgICAgICAgeCA9PiB4Lm5hbWUgPT09IHNraWxsTmFtZVxuICAgICAgICAgICAgKSB8fFxuICAgICAgICAgICAgYXBwLnNvdXJjZS5lbmVteVt4LmluZGV4XS5zdGF0dXMub25TdGF0ZS5zb21lKFxuICAgICAgICAgICAgICB4ID0+IHgubmFtZSA9PT0gc2tpbGxOYW1lXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGlmIChtYXJraW5nID09PSB0cnVlKSB7XG4gICAgICAgICAgICB4LmJ1dHRvbiA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHBheWxvYWQuYWltID09PSBcImFsbGVuZW15XCIgfHwgcGF5bG9hZC5haW0gPT09IFwicmFuZG9tZW5lbXlcIikge1xuICAgICAgYXBwLnN0YXRlLmJ1dHRvbi5lbmVteS5mb3JFYWNoKFxuICAgICAgICB4ID0+ICh4LmJ1dHRvbiA9IHguZGlzYWJsZWQgPyB0cnVlIDogIXguYnV0dG9uKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBheWxvYWQuYWltID09PSBcImFsbGVuZW15YWxsYWxseVwiKSB7XG4gICAgICBhcHAuc3RhdGUuYnV0dG9uLmVuZW15LmZvckVhY2goXG4gICAgICAgIHggPT4gKHguYnV0dG9uID0geC5kaXNhYmxlZCA/IHRydWUgOiAheC5idXR0b24pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGF5bG9hZC5haW0gPT09IFwiYWxseVwiKSB7XG4gICAgICBhcHAuc3RhdGUuYnV0dG9uLmFsbHkuZm9yRWFjaChcbiAgICAgICAgeCA9PiAoeC5idXR0b24gPSB4LmRpc2FibGVkID8gdHJ1ZSA6ICF4LmJ1dHRvbilcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwYXlsb2FkLmFpbSA9PT0gXCJhbGxhbGx5XCIpIHtcbiAgICAgIGFwcC5zdGF0ZS5idXR0b24uYWxseS5mb3JFYWNoKFxuICAgICAgICB4ID0+ICh4LmJ1dHRvbiA9IHguZGlzYWJsZWQgPyB0cnVlIDogIXguYnV0dG9uKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBheWxvYWQuYWltID09PSBcIm90aGVyYWxseVwiKSB7XG4gICAgICBhcHAuc3RhdGUuYnV0dG9uLmFsbHkuZm9yRWFjaCh4ID0+IHtcbiAgICAgICAgbGV0IG5hbWUgPSBhcHAuc3RhdGUuYnV0dG9uLmFsbHlbcGF5bG9hZC5oZXJvSW5kZXhdLm5hbWU7XG4gICAgICAgIGlmICh4Lm5hbWUgIT09IG5hbWUpIHtcbiAgICAgICAgICB4LmJ1dHRvbiA9IHguZGlzYWJsZWQgPyB0cnVlIDogIXguYnV0dG9uO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHBheWxvYWQuYWltID09PSBcInNlbGZcIikge1xuICAgICAgYXBwLnN0YXRlLmJ1dHRvbi5hbGx5W3BheWxvYWQuaGVyb0luZGV4XS5idXR0b24gPSBhcHAuc3RhdGUuYnV0dG9uLmFsbHlbXG4gICAgICAgIHBheWxvYWQuaGVyb0luZGV4XG4gICAgICBdLmRpc2FibGVkXG4gICAgICAgID8gdHJ1ZVxuICAgICAgICA6ICFhcHAuc3RhdGUuYnV0dG9uLmFsbHlbcGF5bG9hZC5oZXJvSW5kZXhdLmJ1dHRvbjtcbiAgICB9XG4gIH1cblxuICAvL1NraWxsIEJ1dHRvblxuICBpZiAob3B0aW9uID09PSBcIm9uU2tpbGxcIikge1xuICAgIGNvbnNvbGUubG9nKFwib25Ta2lsbFwiKTtcbiAgICBhcHAuc3RhdGUuYnV0dG9uLmFsbHkuZm9yRWFjaCh4ID0+IHtcbiAgICAgIGlmICh4Lm9uU2tpbGwgPT09IGZhbHNlKSB7XG4gICAgICAgIHguc2tpbGwuZm9yRWFjaChzID0+IHtcbiAgICAgICAgICBzLmJ1dHRvbiA9IHRydWU7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgeC5uYW1lID09PSBwYXlsb2FkLm9mZmVuc2UgJiZcbiAgICAgICAgICAgIHMubmFtZSA9PT1cbiAgICAgICAgICAgICAgYXBwLnNvdXJjZS5hbGx5W3BheWxvYWQuaGVyb0luZGV4XS5za2lsbFtwYXlsb2FkLnNraWxsXS5uYW1lXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBzLmJ1dHRvbiA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgaWYgKG9wdGlvbiA9PT0gXCJvbkNhbmNlbFwiKSB7XG4gICAgY29uc29sZS5sb2coXCJvbkNhbmNlbFwiKTtcbiAgICBhcHAuc3RhdGUuYnV0dG9uLmFsbHkuZm9yRWFjaCh4ID0+IHtcbiAgICAgIGlmICh4Lm9uU2tpbGwgPT09IGZhbHNlIHx8IHgubmFtZSA9PT0gcGF5bG9hZC5vZmZlbnNlKSB7XG4gICAgICAgIHguc2tpbGwuZm9yRWFjaChzID0+IHtcbiAgICAgICAgICBzLmJ1dHRvbiA9IHMuZGlzYWJsZWQgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgeC5uYW1lID09PSBwYXlsb2FkLm9mZmVuc2UgJiZcbiAgICAgICAgICAgIHMubmFtZSA9PT1cbiAgICAgICAgICAgICAgYXBwLnNvdXJjZS5hbGx5W3BheWxvYWQuaGVyb0luZGV4XS5za2lsbFtwYXlsb2FkLnNraWxsXS5uYW1lXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBzLmJ1dHRvbiA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAob3B0aW9uID09PSBcIm9uVGFyZ2V0XCIpIHtcbiAgICBjb25zb2xlLmxvZyhcIm9uVGFyZ2V0XCIpO1xuICAgIGFwcC5zdGF0ZS5idXR0b24uYWxseS5mb3JFYWNoKHggPT4ge1xuICAgICAgbGV0IGluZGV4ID0gYXBwLnBhY2tldC5maW5kSW5kZXgocyA9PiBzLm9mZmVuc2UgPT09IHgubmFtZSk7XG4gICAgICBpZiAoaW5kZXggPCAwKSB7XG4gICAgICAgIHguc2tpbGwuZm9yRWFjaChzID0+IHtcbiAgICAgICAgICBzLmJ1dHRvbiA9IHMuZGlzYWJsZWQgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGVsc2UgaWYgKG9wdGlvbiA9PT0gXCJvblNlbGZcIikge1xuICAgIGNvbnNvbGUubG9nKFwib25TZWxmXCIpO1xuICAgIGFwcC5zdGF0ZS5idXR0b24uYWxseVtwYXlsb2FkLmhlcm9JbmRleF0uc2tpbGwuZm9yRWFjaChzID0+IHtcbiAgICAgIHMuYnV0dG9uID0gcy5kaXNhYmxlZCA/IHRydWUgOiBmYWxzZTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vRW5lcmd5IE1hbmFnZW1lbnRcbiAgaWYgKG9wdGlvbiAhPT0gXCJvblNraWxsXCIpIHtcbiAgICBhcHAuc3RhdGUuYnV0dG9uLmFsbHkuZm9yRWFjaCgoeCwgeGkpID0+IHtcbiAgICAgIGlmICh4Lm9uU2tpbGwgPT09IGZhbHNlICYmIHgubmFtZSAhPT0gcGF5bG9hZC5vZmZlbnNlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKHgubmFtZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKG9wdGlvbik7XG4gICAgICAgIHguc2tpbGwuZm9yRWFjaCgocywgc2kpID0+IHtcbiAgICAgICAgICBsZXQgZW5lcmd5ID0gZW5lcmd5TWFuYWdlbWVudCh7IGhlcm9JbmRleDogeGksIHNraWxsOiBzaSB9LCBcImNoZWNrXCIpO1xuICAgICAgICAgIHMuYnV0dG9uID0gcy5kaXNhYmxlZCB8fCBlbmVyZ3kgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgeC5uYW1lID09PSBwYXlsb2FkLm9mZmVuc2UgJiZcbiAgICAgICAgICAgIHMubmFtZSA9PT1cbiAgICAgICAgICAgICAgYXBwLnNvdXJjZS5hbGx5W3BheWxvYWQuaGVyb0luZGV4XS5za2lsbFtwYXlsb2FkLnNraWxsXS5uYW1lXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBzLmJ1dHRvbiA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChcbiAgICAgICAgKG9wdGlvbiA9PT0gXCJvblNlbGZcIiB8fCBvcHRpb24gPT09IFwib25DYW5jZWxcIikgJiZcbiAgICAgICAgeC5uYW1lID09PSBwYXlsb2FkLm9mZmVuc2VcbiAgICAgICkge1xuICAgICAgICB4LnNraWxsLmZvckVhY2goKHMsIHNpKSA9PiB7XG4gICAgICAgICAgbGV0IGVuZXJneSA9IGVuZXJneU1hbmFnZW1lbnQoeyBoZXJvSW5kZXg6IHhpLCBza2lsbDogc2kgfSwgXCJjaGVja1wiKTtcbiAgICAgICAgICBzLmJ1dHRvbiA9IHMuZGlzYWJsZWQgfHwgZW5lcmd5ID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIiwiZnVuY3Rpb24gdnVlQmluZChwYXlsb2FkKSB7XG4gIGxldCB1c2VybmFtZSA9IGdldENvb2tpZShcInVzZXJuYW1lXCIpO1xuICBpZiAocGF5bG9hZC50ZWFtLnRlYW1FdmVuICE9PSB1c2VybmFtZSAmJiBwYXlsb2FkLnRlYW0udGVhbU9kZCAhPT0gdXNlcm5hbWUpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc29sZS5sb2cocGF5bG9hZCk7XG4gIGxldCBhbGx5ID0gcGF5bG9hZC50ZWFtLnRlYW1FdmVuID09PSB1c2VybmFtZSA/IFwidGVhbUV2ZW5cIiA6IFwidGVhbU9kZFwiO1xuICBsZXQgZW5lbXkgPSBwYXlsb2FkLnRlYW0udGVhbUV2ZW4gPT09IHVzZXJuYW1lID8gXCJ0ZWFtT2RkXCIgOiBcInRlYW1FdmVuXCI7XG4gIGxldCB0dXJuID0gYWxseSA9PT0gXCJ0ZWFtRXZlblwiID8gMSA6IDA7XG4gIGxldCBteVR1cm4gPSBwYXlsb2FkLnR1cm4gJSAyID09PSB0dXJuID8gdHJ1ZSA6IGZhbHNlO1xuICBsZXQgc3RvcmUgPSB7XG4gICAgZW5lcmd5OiB7XG4gICAgICBhbGx5OiBwYXlsb2FkLmVuZXJneVthbGx5XSxcbiAgICAgIGVuZW15OiBwYXlsb2FkLmVuZXJneVtlbmVteV1cbiAgICB9LFxuICAgIGFsbHk6IHBheWxvYWRbYWxseV0sXG4gICAgZW5lbXk6IHBheWxvYWRbZW5lbXldLFxuICAgIHR1cm46IHBheWxvYWQudHVybixcbiAgICBteVR1cm46IG15VHVybixcbiAgICByb29tOiBwYXlsb2FkLnJvb21cbiAgfTtcbiAgc3RvcmUuZW5lcmd5LmFsbHkuciA9XG4gICAgc3RvcmUuZW5lcmd5LmFsbHkuYSArXG4gICAgc3RvcmUuZW5lcmd5LmFsbHkuaSArXG4gICAgc3RvcmUuZW5lcmd5LmFsbHkucyArXG4gICAgc3RvcmUuZW5lcmd5LmFsbHkudztcbiAgY29uc29sZS5sb2coc3RvcmUpO1xuICBsZXQgYnV0dG9uID0ge1xuICAgIGFsbHk6IHN0b3JlLmFsbHkubWFwKHggPT4ge1xuICAgICAgLy8gbGV0IGRpc2FibGVkID0geC5zdGF0dXMub25TdGF0ZS5maW5kSW5kZXgoeCA9PiB4LnR5cGUgPT09ICdzdHVuJykgPiAtMSB8fCB4LmhwIDw9IDAgPyB0cnVlIDogZmFsc2VcbiAgICAgIGxldCBkaXNhYmxlZCA9IHguaHAgPD0gMCA/IHRydWUgOiBmYWxzZTtcbiAgICAgIGxldCBzdHVuID1cbiAgICAgICAgeC5zdGF0dXMub25TdGF0ZS5maW5kSW5kZXgoeCA9PiB4LnR5cGUgPT09IFwic3R1blwiKSA+IC0xID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogeC5uYW1lLFxuICAgICAgICBidXR0b246IHRydWUsXG4gICAgICAgIG9uU2tpbGw6IGZhbHNlLFxuICAgICAgICBkaXNhYmxlZDogZGlzYWJsZWQsXG4gICAgICAgIHNraWxsOiB4LnNraWxsLm1hcChzID0+IHtcbiAgICAgICAgICBsZXQgZW5lcmd5ID0gZW5lcmd5TWFuYWdlbWVudChcbiAgICAgICAgICAgIHsgZW5lcmd5OiBzdG9yZS5lbmVyZ3kuYWxseSwgc2tpbGxCaW5kOiBzLmVuZXJneSB9LFxuICAgICAgICAgICAgXCJjaGVja1wiXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhlbmVyZ3kpO1xuICAgICAgICAgIGxldCBkaXNhYmxlZCA9XG4gICAgICAgICAgICBzdHVuIHx8XG4gICAgICAgICAgICBzLnJlcXVpcmVkIHx8XG4gICAgICAgICAgICBzLnN0YXRlID09PSBcImNvb2xkb3duXCIgfHxcbiAgICAgICAgICAgICFteVR1cm4gPT09IGZhbHNlIHx8XG4gICAgICAgICAgICB4LmhwIDw9IDBcbiAgICAgICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgICAgIDogZmFsc2U7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IHMubmFtZSxcbiAgICAgICAgICAgIGRpc2FibGVkOiBkaXNhYmxlZCxcbiAgICAgICAgICAgIGJ1dHRvbjogZGlzYWJsZWQgfHwgZW5lcmd5ID8gdHJ1ZSA6IGZhbHNlXG4gICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICAgIH07XG4gICAgfSksXG4gICAgZW5lbXk6IHN0b3JlLmVuZW15Lm1hcCgoeCwgaSkgPT4ge1xuICAgICAgbGV0IGRpc2FibGVkID1cbiAgICAgICAgeC5zdGF0dXMub25TdGF0ZS5maW5kSW5kZXgoeCA9PiB4LnR5cGUgPT09IFwiaW52aW5jaWJsZVwiKSA+IC0xIHx8XG4gICAgICAgIHguaHAgPD0gMFxuICAgICAgICAgID8gdHJ1ZVxuICAgICAgICAgIDogZmFsc2U7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB4Lm5hbWUsXG4gICAgICAgIGluZGV4OiBpLFxuICAgICAgICBkaXNhYmxlZDogZGlzYWJsZWQsXG4gICAgICAgIGJ1dHRvbjogdHJ1ZVxuICAgICAgfTtcbiAgICB9KVxuICB9O1xuICBhcHAuc291cmNlID0gc3RvcmU7XG4gIGFwcC5zdGF0ZS5idXR0b24gPSBidXR0b247XG4gIGFwcC5zdGF0ZS50aW1lci50dXJuID0gMTAwO1xuICBhcHAuc3RhdGUud2lubmVyID0gcGF5bG9hZC53aW5uZXI7XG59XG4iLCJmdW5jdGlvbiBpbml0aWF0ZSgpIHtcbiAgbGV0IHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KFwiL1wiKTtcbiAgbGV0IHJvb20gPSB1cmxbdXJsLmxlbmd0aCAtIDFdO1xuICBpZiAocm9vbSAhPT0gXCJcIikge1xuICAgIHNvY2tldC5lbWl0KFwiaW5pdGlhdGVcIiwge1xuICAgICAgcm9vbTogcm9vbVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIC8vIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCcvJyk7XG4gIH1cbn1cblxuaW5pdGlhdGUoKTtcblxuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICBpZiAoYXBwLnNvdXJjZS50dXJuID09IHVuZGVmaW5lZCB8fCBhcHAuc3RhdGUud2lubmVyLnN0YXRlICE9PSBmYWxzZSkge1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoYXBwLnN0YXRlLnRpbWVyLnR1cm4gPiAwKSB7XG4gICAgYXBwLnN0YXRlLnRpbWVyLnR1cm4gLT0gMy4zO1xuICB9IGVsc2UgaWYgKGFwcC5zdGF0ZS50aW1lci50dXJuIDw9IDAgJiYgYXBwLnNvdXJjZS5teVR1cm4gPT09IHRydWUpIHtcbiAgICAvLyBhcHAucGFja2V0ID0gYXBwLnBhY2tldC5maWx0ZXIoeCA9PiB4LnNraWxsICE9PSBudWxsICYmIHgub2ZmZW5zZSAhPT0gJycgJiYgeC50YXJnZXQgIT09ICcnICYmIHguYWltICE9PSAnJyAmJiB4Lmhlcm9JbmRleCAhPT0gbnVsbClcbiAgICAvLyBzb2NrZXQuZW1pdCgnc2VxdWVuY2UnLCB7XG4gICAgLy8gICAgIHBhY2tldDogYXBwLnBhY2tldCxcbiAgICAvLyAgICAgcm9vbTogYXBwLnNvdXJjZS5yb29tXG4gICAgLy8gfSlcbiAgICAvLyBhcHAucGFja2V0ID0gW11cbiAgfVxufSwgMTAwMCk7XG5cbndpbmRvdy5vbmZvY3VzID0gZnVuY3Rpb24oKSB7XG4gIGRvY3VtZW50LnRpdGxlID0gXCJBbmltZSBSdW1ibGVcIjtcbn07XG4iLCJzb2NrZXQub24oXCJhcHBseVwiLCBwYXlsb2FkID0+IHtcbiAgZG9jdW1lbnQudGl0bGUgPSBcIighKSBBbmltZSBSdW1ibGVcIjtcbiAgdnVlQmluZChwYXlsb2FkKTtcbn0pO1xuXG5zb2NrZXQub24oXCJub01hdGNoXCIsIHBheWxvYWQgPT4ge1xuICBjb25zb2xlLmxvZyhcIm5vbmVcIik7XG4gIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKFwiL1wiKTtcbn0pO1xuIiwiZnVuY3Rpb24gZ2V0UGFyYW1ldGVyTmFtZShuYW1lLCB1cmwpIHtcbiAgaWYgKCF1cmwpIHVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xuICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bXFxbXFxdXS9nLCBcIlxcXFwkJlwiKTtcbiAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cChcIls/Jl1cIiArIG5hbWUgKyBcIig9KFteJiNdKil8JnwjfCQpXCIpLFxuICAgIHJlc3VsdHMgPSByZWdleC5leGVjKHVybCk7XG4gIGlmICghcmVzdWx0cykgcmV0dXJuIG51bGw7XG4gIGlmICghcmVzdWx0c1syXSkgcmV0dXJuIFwiXCI7XG4gIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1syXS5yZXBsYWNlKC9cXCsvZywgXCIgXCIpKTtcbn1cblxuY29uc3Qgc2V0Q29va2llID0gKG5hbWUsIHZhbHVlLCBkYXlzID0gNywgcGF0aCA9IFwiL1wiKSA9PiB7XG4gIGNvbnN0IGV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgZGF5cyAqIDg2NGU1KS50b0dNVFN0cmluZygpO1xuICBkb2N1bWVudC5jb29raWUgPVxuICAgIG5hbWUgK1xuICAgIFwiPVwiICtcbiAgICBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpICtcbiAgICBcIjsgZXhwaXJlcz1cIiArXG4gICAgZXhwaXJlcyArXG4gICAgXCI7IHBhdGg9XCIgK1xuICAgIHBhdGg7XG59O1xuXG5jb25zdCBnZXRDb29raWUgPSBuYW1lID0+IHtcbiAgcmV0dXJuIGRvY3VtZW50LmNvb2tpZS5zcGxpdChcIjsgXCIpLnJlZHVjZSgociwgdikgPT4ge1xuICAgIGNvbnN0IHBhcnRzID0gdi5zcGxpdChcIj1cIik7XG4gICAgcmV0dXJuIHBhcnRzWzBdID09PSBuYW1lID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcnRzWzFdKSA6IHI7XG4gIH0sIFwiXCIpO1xufTtcblxuY29uc3QgZGVsZXRlQ29va2llID0gKG5hbWUsIHBhdGgpID0+IHtcbiAgc2V0Q29va2llKG5hbWUsIFwiXCIsIC0xLCBwYXRoKTtcbn07XG4iXX0=
